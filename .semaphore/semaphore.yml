version: v1.0
name: Python
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
blocks:
  - name: Test
    task:
      jobs:
        - name: pytest
          commands:
            - sem-version python 3.7
            - checkout
            - python -m pip install --upgrade pip > /dev/null
            - export PYVERSION=$(python -c "import sys; sys.stdout.write(sys.version.split()[0])")
            - wget --quiet https://github.com/python/cpython/archive/v${PYVERSION}.tar.gz
            - tar -xf v${PYVERSION}.tar.gz -C /tmp
            - cp -r /tmp/cpython-${PYVERSION}/Lib/test ~/cpython_tests
            - export PYTHONPATH=~/cpython_tests/
            - python -m pip install -r requirements.txt > /dev/null
            - python -m pip install flake8 pytest > /dev/null
            - flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
            - >-
              flake8 . --count --exit-zero --max-complexity=10 --max-line-length=160 --statistics
            - sem-service start redis
            - docker run --detach --publish 9123:8000 amazon/dynamodb-local
            - python -m pytest -vvv
